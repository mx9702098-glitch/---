<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‘åŠ¡ç®¡ç†åŠ©æ‰‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background: #f8fafc;
        }

        /* åº”ç”¨å®¹å™¨ */
        .app-container {
            width: 100%;
            max-width: 480px;
            margin: 0 auto;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: linear-gradient(to bottom, #f0f4f8, #e2e8f0);
        }

        /* é¡¶éƒ¨æŒ‰é’®æ  */
        .top-bar {
            display: flex;
            gap: 8px;
            padding: 12px;
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            z-index: 10;
        }

        .top-button {
            flex: 1;
            font-size: 13px;
            height: 40px;
            border-radius: 8px;
            transition: all 0.2s;
            border: 1px solid #e2e8f0;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .top-button:hover {
            background: #f7fafc;
            border-color: #667eea;
        }

        .top-button:active {
            transform: scale(0.95);
        }

        /* å¯¹è¯æµåŒºåŸŸ */
        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 16px 12px 80px 12px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* æ¶ˆæ¯å®¹å™¨ */
        .message {
            display: flex;
            gap: 8px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.agent {
            flex-direction: row;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .message-avatar.user {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .message-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .message-text {
            background: white;
            padding: 12px 16px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.06);
            line-height: 1.5;
            font-size: 14px;
        }

        .message.user .message-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
        }

        /* åŠŸèƒ½å¡ç‰‡ */
        .card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid #e2e8f0;
        }

        .card-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #1a202c;
        }

        .card-subtitle {
            font-size: 13px;
            color: #64748b;
            margin-top: 4px;
            margin-bottom: 12px;
        }

        .card-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .card-button {
            width: 100%;
            justify-content: flex-start;
            text-align: left;
            height: auto;
            padding: 12px 16px;
            font-size: 14px;
            transition: all 0.2s;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-button:hover {
            background: #f7fafc;
            border-color: #667eea;
        }

        .card-button:active {
            transform: scale(0.98);
        }

        /* æ¨¡å¼é€‰æ‹©æŒ‰é’® */
        .mode-button {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 16px;
        }

        .mode-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .mode-content {
            flex: 1;
            text-align: left;
        }

        .mode-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: #1a202c;
        }

        .mode-desc {
            font-size: 12px;
            color: #718096;
            line-height: 1.4;
        }

        /* å­—æ®µåˆ—è¡¨ */
        .field-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }

        .field-item {
            display: flex;
            align-items: center;
            gap: 6px;
            background: #f7fafc;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            border: 1px solid #e2e8f0;
        }

        .field-remove {
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            color: #e53e3e;
            display: flex;
            align-items: center;
            transition: transform 0.2s;
        }

        .field-remove:hover {
            transform: scale(1.2);
        }

        .field-add {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .field-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 13px;
            outline: none;
            transition: border-color 0.2s;
        }

        .field-input:focus {
            border-color: #667eea;
        }

        /* ç¡®è®¤ä¿¡æ¯ */
        .confirm-info {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 8px;
        }

        .confirm-row {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .confirm-label {
            font-size: 12px;
            color: #718096;
            font-weight: 500;
        }

        .confirm-value {
            font-size: 14px;
            color: #1a202c;
            line-height: 1.5;
        }

        /* è¿›åº¦ä¿¡æ¯ */
        .progress-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 8px;
        }

        .progress-row {
            display: flex;
            align-items: center;
            font-size: 14px;
        }

        /* å¯¼å‡ºæè¿° */
        .export-desc {
            font-size: 13px;
            color: #718096;
            line-height: 1.6;
            margin-top: 8px;
        }

        /* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ */
        .file-upload-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 32px 16px;
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            background: #f7fafc;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-upload-area:hover {
            border-color: #667eea;
            background: #edf2f7;
        }

        /* åº•éƒ¨è¾“å…¥æ  */
        .input-bar {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 480px;
            display: flex;
            gap: 8px;
            padding: 12px;
            background: white;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.08);
            z-index: 10;
        }

        .chat-input {
            flex: 1;
            padding: 10px 16px;
            border: 1px solid #e2e8f0;
            border-radius: 24px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        .chat-input:focus {
            border-color: #667eea;
        }

        .icon-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: #667eea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .icon-button:hover {
            background: #5568d3;
        }

        .icon-button:active {
            transform: scale(0.95);
        }

        /* äººå‘˜åˆ—è¡¨ */
        .people-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            padding: 8px;
            background: #f7fafc;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .people-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .people-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .people-name {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
            color: #1e293b;
        }

        .fill-button {
            font-size: 12px;
            padding: 4px 12px;
            height: auto;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 4px;
            cursor: pointer;
        }

        .card-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            padding-top: 8px;
            border-top: 1px solid #e2e8f0;
        }

        .select-all {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            color: #475569;
            cursor: pointer;
        }

        .select-all input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* ä»£å¡«è¡¨å•æ ·å¼ */
        .fill-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 12px;
        }

        .form-field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-field label {
            font-size: 13px;
            font-weight: 500;
            color: #475569;
        }

        .form-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            border-color: #3b82f6;
        }

        .form-input:disabled {
            background: #f1f5f9;
            color: #94a3b8;
            cursor: not-allowed;
        }

        .form-input::placeholder {
            color: #94a3b8;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-outline {
            background: white;
            color: #374151;
            border: 1px solid #e2e8f0;
        }

        .btn-outline:hover {
            background: #f7fafc;
            border-color: #667eea;
        }

        .btn-sm {
            padding: 4px 12px;
            font-size: 12px;
        }

        .w-full {
            width: 100%;
        }

        .mt-3 {
            margin-top: 12px;
        }

        /* è‡ªå®šä¹‰äººç¾¤åˆ—è¡¨ */
        .custom-audience-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
            max-height: 200px;
            overflow-y: auto;
            padding: 8px;
            background: #f7fafc;
            border-radius: 8px;
        }

        .audience-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: white;
            border-radius: 6px;
            font-size: 13px;
        }

        .audience-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        .chat-area::-webkit-scrollbar,
        .people-list::-webkit-scrollbar,
        .custom-audience-list::-webkit-scrollbar {
            width: 4px;
        }

        .chat-area::-webkit-scrollbar-track,
        .people-list::-webkit-scrollbar-track,
        .custom-audience-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-area::-webkit-scrollbar-thumb,
        .people-list::-webkit-scrollbar-thumb,
        .custom-audience-list::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 2px;
        }

        .chat-area::-webkit-scrollbar-thumb:hover,
        .people-list::-webkit-scrollbar-thumb:hover,
        .custom-audience-list::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }

        /* éšè—æ–‡ä»¶è¾“å…¥ */
        input[type="file"] {
            display: none;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 480px) {
            .app-container {
                max-width: 100%;
            }
            
            .input-bar {
                max-width: 100%;
            }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- é¡¶éƒ¨å›ºå®šæŒ‰é’®æ  -->
        <div class="top-bar">
            <button class="top-button" onclick="handleUploadFile()">
                ğŸ“ ä¸Šä¼ æ–‡ä»¶
            </button>
            <button class="top-button" onclick="handleTaskStatus()">
                ğŸ“Š ä»»å‹™æƒ…æ³
            </button>
            <button class="top-button" onclick="handleExportTable()">
                ğŸ“„ å¯¼å‡ºè¡¨æ ¼
            </button>
        </div>

        <!-- å¯¹è¯æµåŒºåŸŸ -->
        <div class="chat-area" id="chatArea">
            <div class="message agent">
                <div class="message-avatar">ğŸ¤–</div>
                <div class="message-content">
                    <div class="message-text">æ‚¨å¥½,æä¹¦è®°!ä»Šå¤©æœ‰ä»€ä¹ˆå¡«è¡¨ä»»åŠ¡éœ€è¦æˆ‘å¸®å¿™å—?</div>
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨è¾“å…¥æ  -->
        <div class="input-bar">
            <input
                type="text"
                placeholder="è¾“å…¥æ¶ˆæ¯..."
                id="chatInput"
                class="chat-input"
                onkeypress="handleKeyPress(event)"
            />
            <button class="icon-button">
                ğŸ¤
            </button>
            <button class="icon-button" onclick="handleSendMessage()">
                â¤
            </button>
        </div>
    </div>

    <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
    <input type="file" id="fileInput" accept=".xlsx,.xls,.doc,.docx,.pdf" onchange="handleFileChange(event, 'local')">
    <input type="file" id="wechatFileInput" accept=".xlsx,.xls,.doc,.docx,.pdf" onchange="handleFileChange(event, 'wechat')">
    <input type="file" id="assistMaterialInput" accept=".xlsx,.xls,.doc,.docx,.pdf" onchange="handleAssistMaterialChange(event)">

    <script>
        let messages = [];
        let currentStep = 'welcome';
        let selectedFields = ['å§“å', 'èº«ä»½è¯å·', 'æˆ¿å±‹ç»“æ„', 'éšæ‚£ç­‰çº§', 'æ’æŸ¥äºº'];
        let selectedPeople = [];
        let selectAll = false;

        const peopleList = [
            { id: 1, name: 'ç‹å¤§å¦ˆ' },
            { id: 2, name: 'æå”' },
            { id: 3, name: 'èµµå››' },
            { id: 4, name: 'é™ˆä¼¯' },
            { id: 5, name: 'å¼ å©¶' },
            { id: 6, name: 'åˆ˜å¤§çˆ·' },
            { id: 7, name: 'å­™å¤§å§' },
            { id: 8, name: 'å‘¨å”' }
        ];

        function addMessage(type, text, card = null) {
            const chatArea = document.getElementById('chatArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            let avatarHtml = '';
            if (type === 'agent') {
                avatarHtml = '<div class="message-avatar">ğŸ¤–</div>';
            } else {
                avatarHtml = '<div class="message-avatar user">ğŸ‘¤</div>';
            }
            
            let contentHtml = '';
            if (text) {
                contentHtml += `<div class="message-text">${text}</div>`;
            }
            if (card) {
                contentHtml += renderCard(card);
            }
            
            if (type === 'agent') {
                messageDiv.innerHTML = avatarHtml + '<div class="message-content">' + contentHtml + '</div>';
            } else {
                messageDiv.innerHTML = '<div class="message-content">' + contentHtml + '</div>' + avatarHtml;
            }
            
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function renderCard(card) {
            switch (card.type) {
                case 'fileSource':
                    return `
                        <div class="card">
                            <div class="card-title">è¯·é€‰æ‹©åˆ›å»ºæ–¹å¼</div>
                            <div class="card-buttons">
                                <button class="card-button" onclick="handleLocalFileUpload()">
                                    ğŸ“ ä»æœ¬åœ°æ–‡ä»¶ä¸Šä¼ 
                                </button>
                                <button class="card-button" onclick="handleWechatFileUpload()">
                                    ğŸ’¬ ä»å¾®ä¿¡èŠå¤©è®°å½•é€‰æ‹©
                                </button>
                                <button class="card-button" onclick="handlePhotoRecognition()">
                                    ğŸ“· æ‹ç…§è¯†åˆ«è¡¨æ ¼
                                </button>
                            </div>
                        </div>
                    `;
                
                case 'fieldConfirm':
                    let fieldsHtml = selectedFields.map(field => 
                        `<div class="field-item">
                            <span>${field}</span>
                            <button onclick="removeField('${field}')" class="field-remove">âœ•</button>
                        </div>`
                    ).join('');
                    
                    return `
                        <div class="card">
                            <div class="card-title">å­—æ®µç¡®è®¤</div>
                            <div class="field-list">${fieldsHtml}</div>
                            <div class="field-add">
                                <input type="text" placeholder="è¾“å…¥æ–°å­—æ®µåç§°" id="newFieldInput" class="field-input">
                                <button class="btn btn-outline btn-sm" onclick="addField()">
                                    â• å¢åŠ å­—æ®µ
                                </button>
                            </div>
                            <button class="btn btn-primary w-full mt-3" onclick="handleFieldConfirm()">
                                âœ… ç¡®å®šå­—æ®µ,ä¸‹ä¸€æ­¥
                            </button>
                        </div>
                    `;
                
                case 'modeSelect':
                    return `
                        <div class="card">
                            <div class="card-title">è¯·é€‰æ‹©ä»»åŠ¡æ¨¡å¼</div>
                            <div class="card-buttons">
                                <button class="card-button mode-button" onclick="handleModeSelect('direct')">
                                    <div class="mode-icon">âœï¸</div>
                                    <div class="mode-content">
                                        <div class="mode-title">ç›´æ¥å¡«å†™</div>
                                        <div class="mode-desc">é€‚ç”¨äºç´§æ€¥ä»»åŠ¡,ç”±æ‚¨ç›´æ¥å¡«å†™æˆ–ä¸Šä¼ ææ–™</div>
                                    </div>
                                </button>
                                <button class="card-button mode-button" onclick="handleModeSelect('collect')">
                                    <div class="mode-icon">ğŸ“¢</div>
                                    <div class="mode-content">
                                        <div class="mode-title">æ”¶é›†ä¿¡æ¯</div>
                                        <div class="mode-desc">é€‚ç”¨äºå¸¸è§„ä»»åŠ¡,å‘æ‘æ°‘åˆ†å‘å¹¶æ”¶é›†</div>
                                    </div>
                                </button>
                            </div>
                        </div>
                    `;
                
                case 'directFillOptions':
                    return `
                        <div class="card">
                            <div class="card-title">è¯·é€‰æ‹©å¡«å†™æ–¹å¼</div>
                            <div class="card-buttons">
                                <button class="card-button" onclick="handleAssistMaterialUpload()">
                                    ğŸ“¤ ä¸Šä¼ è¾…åŠ©ææ–™è‡ªåŠ¨è¯†åˆ«å¡«å†™
                                </button>
                                <button class="card-button" onclick="handleReadFromVillageTable()">
                                    ğŸ“Š ä»æ‘åº„å¤§è¡¨è¯»å–ä¿¡æ¯å¡«å†™
                                </button>
                            </div>
                        </div>
                    `;
                
                case 'fillResult':
                    return `
                        <div class="card">
                            <div class="card-title">å¡«å†™ç»“æœ</div>
                            <div class="export-desc">
                                è¡¨æ ¼å·²è‡ªåŠ¨å¡«å†™å®Œæˆ,æ‚¨å¯ä»¥å¯¼å‡ºæŸ¥çœ‹æˆ–ç»§ç»­æ‰‹åŠ¨ç¼–è¾‘ã€‚
                            </div>
                            <button class="btn btn-primary w-full mt-3">
                                ğŸ“¥ å¯¼å‡ºå·²å¡«å†™è¡¨æ ¼
                            </button>
                        </div>
                    `;
                
                case 'audienceSelect':
                    return `
                        <div class="card">
                            <div class="card-title">è¯·é€‰æ‹©é€šçŸ¥äººç¾¤</div>
                            <div class="card-buttons">
                                <button class="card-button" onclick="handleAudienceSelect('household')">
                                    ğŸ‘¤ æŒ‰æˆ·ä¸»
                                </button>
                                <button class="card-button" onclick="handleAudienceSelect('specific')">
                                    ğŸ¯ æŒ‰ç‰¹å®šäººç¾¤
                                </button>
                                <button class="card-button" onclick="handleAudienceSelect('all')">
                                    å…¨å‘˜
                                </button>
                                <button class="card-button" onclick="handleAudienceSelect('custom')">
                                    âœï¸ è‡ªå®šä¹‰é€‰æ‹©
                                </button>
                            </div>
                        </div>
                    `;
                
                case 'specificAudience':
                    return `
                        <div class="card">
                            <div class="card-title">è¯·é€‰æ‹©ç‰¹å®šäººç¾¤ç±»å‹</div>
                            <div class="card-buttons">
                                <button class="card-button" onclick="handleSpecificAudienceSelect('lowIncome')">
                                    ğŸ’° ä½ä¿æˆ· (45äºº)
                                </button>
                                <button class="card-button" onclick="handleSpecificAudienceSelect('elderly')">
                                    ğŸ‘´ 60å²ä»¥ä¸Šè€äºº (89äºº)
                                </button>
                                <button class="card-button" onclick="handleSpecificAudienceSelect('disabled')">
                                    â™¿ æ®‹ç–¾äºº (23äºº)
                                </button>
                                <button class="card-button" onclick="handleSpecificAudienceSelect('poverty')">
                                    ğŸ“‹ å»ºæ¡£ç«‹å¡è´«å›°æˆ· (37äºº)
                                </button>
                            </div>
                        </div>
                    `;
                
                case 'customAudience':
                    return `
                        <div class="card">
                            <div class="card-title">è‡ªå®šä¹‰é€‰æ‹©äººå‘˜</div>
                            <div class="export-desc">
                                æ‚¨å¯ä»¥é€šè¿‡æœç´¢å§“åã€èº«ä»½è¯å·æˆ–å…¶ä»–æ¡ä»¶æ¥ç­›é€‰éœ€è¦é€šçŸ¥çš„äººå‘˜ã€‚
                            </div>
                            <div class="field-add mt-3">
                                <input type="text" placeholder="æœç´¢äººå‘˜å§“åæˆ–èº«ä»½è¯å·" class="field-input">
                                <button class="btn btn-outline btn-sm">æœç´¢</button>
                            </div>
                            <div class="custom-audience-list">
                                <div class="audience-item">
                                    <input type="checkbox">
                                    <span>å¼ ä¸‰ (èº«ä»½è¯: 110***********234)</span>
                                </div>
                                <div class="audience-item">
                                    <input type="checkbox">
                                    <span>æå›› (èº«ä»½è¯: 110***********567)</span>
                                </div>
                                <div class="audience-item">
                                    <input type="checkbox">
                                    <span>ç‹äº” (èº«ä»½è¯: 110***********890)</span>
                                </div>
                            </div>
                            <button class="btn btn-primary w-full mt-3" onclick="handleCustomAudienceConfirm()">
                                âœ… ç¡®è®¤é€‰æ‹© (å·²é€‰3äºº)
                            </button>
                        </div>
                    `;
                
                case 'sendConfirm':
                    const count = card.count || 152;
                    return `
                        <div class="card">
                            <div class="card-title">å‘é€ç¡®è®¤</div>
                            <div class="confirm-info">
                                <div class="confirm-row">
                                    <span class="confirm-label">é€šçŸ¥å†…å®¹:</span>
                                    <span class="confirm-value">"å„ä½æˆ·ä¸»,è¯·å°½å¿«å¡«å†™ã€Šå±æˆ¿æ’æŸ¥ç™»è®°è¡¨ã€‹,äº‹å…³å±…ä½å®‰å…¨,æ„Ÿè°¢é…åˆã€‚"</span>
                                </div>
                                <div class="confirm-row">
                                    <span class="confirm-label">å‘é€äººæ•°:</span>
                                    <span class="confirm-value">${count}äºº</span>
                                </div>
                            </div>
                            <button class="btn btn-primary w-full mt-3" onclick="handleSendConfirm(${count})">
                                ğŸš€ ç¡®è®¤å‘é€
                            </button>
                        </div>
                    `;
                
                case 'taskSummary':
                    return `
                        <div class="card">
                            <div class="card-title">å±æˆ¿æ’æŸ¥ç™»è®°è¡¨ - ä»»åŠ¡è¿›åº¦</div>
                            <div class="progress-info">
                                <div class="progress-row">
                                    <span>âœ… å·²å¡«å†™: 35/152</span>
                                </div>
                                <div class="progress-row">
                                    <span>âœï¸ æœªå¡«å†™: 117/152</span>
                                </div>
                            </div>
                            <button class="btn btn-primary w-full mt-3" onclick="handleViewDetailList()">
                                â¡ï¸ æŸ¥çœ‹è¯¦ç»†åå•ä¸æ“ä½œ
                            </button>
                        </div>
                    `;
                
                case 'detailList':
                    return renderDetailListCard();
                
                case 'fillForm':
                    return `
                        <div class="card">
                            <div class="card-title">ä¸º ${card.name} ä»£å¡«è¡¨å•</div>
                            <div class="fill-form">
                                <div class="form-field">
                                    <label>å§“å</label>
                                    <input type="text" value="${card.name}" disabled class="form-input">
                                </div>
                                <div class="form-field">
                                    <label>èº«ä»½è¯å·</label>
                                    <input type="text" placeholder="è¯·è¾“å…¥èº«ä»½è¯å·" class="form-input">
                                </div>
                                <div class="form-field">
                                    <label>æˆ¿å±‹ç»“æ„</label>
                                    <input type="text" placeholder="è¯·è¾“å…¥æˆ¿å±‹ç»“æ„" class="form-input">
                                </div>
                                <div class="form-field">
                                    <label>éšæ‚£ç­‰çº§</label>
                                    <select class="form-input">
                                        <option>è¯·é€‰æ‹©</option>
                                        <option>æ— éšæ‚£</option>
                                        <option>ä¸€èˆ¬éšæ‚£</option>
                                        <option>ä¸¥é‡éšæ‚£</option>
                                    </select>
                                </div>
                                <div class="form-field">
                                    <label>æ’æŸ¥äºº</label>
                                    <input type="text" placeholder="è¯·è¾“å…¥æ’æŸ¥äºº" class="form-input">
                                </div>
                            </div>
                            <button class="btn btn-primary w-full mt-3">
                                âœ… æäº¤ä»£å¡«è¡¨å•
                            </button>
                        </div>
                    `;
                
                case 'exportDraft':
                    return `
                        <div class="card">
                            <div class="card-title">å¯¼å‡ºæ•°æ®è‰ç¨¿</div>
                            <div class="export-desc">
                                å½“å‰æ•°æ®å°†å¯¼å‡ºä¸ºExcelæ–‡ä»¶,æ–¹ä¾¿æ‚¨åœ¨ç”µè„‘ä¸Šè¿›è¡Œæœ€ç»ˆå®¡æ ¸ã€ä¿®æ”¹,å¹¶è¡¥å……æœªåœ¨å¹³å°ä¸Šçš„æ‘æ°‘ä¿¡æ¯ã€‚
                            </div>
                            <button class="btn btn-primary w-full mt-3" onclick="handleExportDraft()">
                                ğŸ“¥ å¯¼å‡ºè‰ç¨¿Excel
                            </button>
                        </div>
                    `;
                
                case 'fileUpload':
                    return `
                        <div class="card">
                            <div class="file-upload-area">
                                <div style="font-size: 48px; color: #9ca3af; margin-bottom: 8px;">ğŸ“</div>
                                <div style="font-size: 14px; color: #9ca3af;">ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </div>
                                <button class="btn btn-outline mt-3">é€‰æ‹©æ–‡ä»¶</button>
                            </div>
                        </div>
                    `;
                
                default:
                    return '';
            }
        }

        function renderDetailListCard() {
            let peopleHtml = peopleList.map(person => `
                <div class="people-item">
                    <input type="checkbox" ${selectedPeople.includes(person.id) ? 'checked' : ''} 
                           onchange="handleSelectPerson(${person.id})">
                    <span class="people-name">${person.name}</span>
                    <button class="fill-button" onclick="handleFillFor('${person.name}')">
                        âœï¸ ä»£ä¸ºå¡«å†™
                    </button>
                </div>
            `).join('');

            return `
                <div class="card">
                    <div class="card-title">æœªå¡«å†™äººå‘˜åå• (117äºº)</div>
                    <div class="card-subtitle">å¯åœ¨æ­¤å¯¹æ‘æ°‘è¿›è¡Œå•ç‹¬æˆ–æ‰¹é‡æ“ä½œ</div>
                    <div class="people-list">${peopleHtml}</div>
                    <div class="card-actions">
                        <div class="select-all">
                            <input type="checkbox" ${selectAll ? 'checked' : ''} onchange="handleSelectAll()">
                            <span>å…¨é€‰</span>
                        </div>
                        <button class="btn btn-outline btn-sm" ${selectedPeople.length === 0 ? 'disabled' : ''} 
                                onclick="handleBatchRemind()">
                            ğŸ”” å‚¬åŠé€‰ä¸­äººå‘˜
                        </button>
                        <button class="btn btn-outline btn-sm" onclick="handleRemindAll()">
                            ğŸ“£ ä¸€é”®å‚¬åŠæ‰€æœ‰æœªå¡«å†™äººå‘˜
                        </button>
                    </div>
                </div>
            `;
        }

        // äº‹ä»¶å¤„ç†å‡½æ•°
        function handleUploadFile() {
            currentStep = 'upload';
            addMessage('agent', 'å¥½çš„,è¯·é€‰æ‹©æ‚¨çš„æ–‡ä»¶æ¥æº,æˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ªæ–°ä»»åŠ¡ã€‚', { type: 'fileSource' });
        }

        function handleTaskStatus() {
            addMessage('agent', 'å¥½çš„,è¿™æ˜¯"å±æˆ¿æ’æŸ¥ç™»è®°è¡¨"çš„æœ€æ–°ä»»åŠ¡è¿›å±•ã€‚', { type: 'taskSummary' });
        }

        function handleExportTable() {
            addMessage('agent', 'å¥½çš„,æˆ‘ä»¬å°†ä¸ºæ‚¨å¯¼å‡ºåŒ…å«å½“å‰æ‰€æœ‰å·²æ”¶é›†æ•°æ®çš„å·¥ä½œè‰ç¨¿ã€‚', { type: 'exportDraft' });
        }

        function handleLocalFileUpload() {
            document.getElementById('fileInput').click();
        }

        function handleWechatFileUpload() {
            document.getElementById('wechatFileInput').click();
        }

        function handlePhotoRecognition() {
            currentStep = 'recognizing';
            addMessage('agent', 'æ­£åœ¨è¯†åˆ«å›¾ç‰‡ä¸­çš„è¡¨æ ¼å­—æ®µ,è¯·ç¨å€™...');
            setTimeout(() => {
                addMessage('agent', 'è¯†åˆ«å®Œæˆ!è¯·æ‚¨ç¡®è®¤ã€ä¿®æ”¹æˆ–å¢åˆ å­—æ®µ,è¿™å°†æ˜¯æ‘æ°‘éœ€è¦å¡«å†™çš„é¡¹ç›®ã€‚', { type: 'fieldConfirm' });
                currentStep = 'fieldConfirm';
            }, 2000);
        }

        function handleFileChange(event, source) {
            const file = event.target.files[0];
            if (file) {
                currentStep = 'recognizing';
                const sourceText = source === 'local' ? 'æœ¬åœ°æ–‡ä»¶' : 'å¾®ä¿¡èŠå¤©è®°å½•';
                addMessage('agent', `æ­£åœ¨è¯†åˆ«${sourceText}"${file.name}"ä¸­çš„è¡¨æ ¼å­—æ®µ,è¯·ç¨å€™...`);
                setTimeout(() => {
                    addMessage('agent', 'è¯†åˆ«å®Œæˆ!è¯·æ‚¨ç¡®è®¤ã€ä¿®æ”¹æˆ–å¢åˆ å­—æ®µ,è¿™å°†æ˜¯æ‘æ°‘éœ€è¦å¡«å†™çš„é¡¹ç›®ã€‚', { type: 'fieldConfirm' });
                    currentStep = 'fieldConfirm';
                }, 2000);
            }
        }

        function removeField(field) {
            selectedFields = selectedFields.filter(f => f !== field);
            // é‡æ–°æ¸²æŸ“å½“å‰å¡ç‰‡
            const lastMessage = document.querySelector('.message:last-child .card');
            if (lastMessage) {
                lastMessage.outerHTML = renderCard({ type: 'fieldConfirm' });
            }
        }

        function addField() {
            const input = document.getElementById('newFieldInput');
            if (input && input.value.trim()) {
                selectedFields.push(input.value.trim());
                input.value = '';
                // é‡æ–°æ¸²æŸ“å½“å‰å¡ç‰‡
                const lastMessage = document.querySelector('.message:last-child .card');
                if (lastMessage) {
                    lastMessage.outerHTML = renderCard({ type: 'fieldConfirm' });
                }
            }
        }

        function handleFieldConfirm() {
            currentStep = 'modeSelect';
            addMessage('agent', 'å­—æ®µå·²ç¡®è®¤!æ¥ä¸‹æ¥æ‚¨å¸Œæœ›å¦‚ä½•å¤„ç†è¿™ä»½è¡¨æ ¼å‘¢?', { type: 'modeSelect' });
        }

        function handleModeSelect(mode) {
            if (mode === 'direct') {
                currentStep = 'directFill';
                addMessage('agent', 'å¥½çš„,æ‚¨é€‰æ‹©äº†ç›´æ¥å¡«å†™æ¨¡å¼ã€‚è¯·é€‰æ‹©å¡«å†™æ–¹å¼:', { type: 'directFillOptions' });
            } else if (mode === 'collect') {
                currentStep = 'audienceSelect';
                addMessage('agent', 'å¥½çš„,æˆ‘ä»¬å°†å‘æ‘æ°‘æ”¶é›†ä¿¡æ¯ã€‚è¯·é€‰æ‹©éœ€è¦é€šçŸ¥çš„äººç¾¤èŒƒå›´ã€‚', { type: 'audienceSelect' });
            }
        }

        function handleAssistMaterialUpload() {
            document.getElementById('assistMaterialInput').click();
        }

        function handleReadFromVillageTable() {
            addMessage('agent', 'æ­£åœ¨ä»æ‘åº„å¤§è¡¨ä¸­è¯»å–å·²æœ‰ä¿¡æ¯å¹¶è¿›è¡ŒAIè‡ªåŠ¨å¡«å†™...');
            setTimeout(() => {
                addMessage('agent', 'âœ… è‡ªåŠ¨å¡«å†™å®Œæˆ!å·²ä»æ‘åº„å¤§è¡¨ä¸­æå–å¹¶å¡«å†™äº†æ‰€æœ‰å¯åŒ¹é…å­—æ®µã€‚è¡¨æ ¼å·²ç”Ÿæˆ,æ‚¨å¯ä»¥å¯¼å‡ºæŸ¥çœ‹ã€‚', { type: 'fillResult' });
            }, 2000);
        }

        function handleAssistMaterialChange(event) {
            const file = event.target.files[0];
            if (file) {
                addMessage('agent', `æ­£åœ¨ä»"${file.name}"ä¸­è¯†åˆ«ç›¸åŒå­—æ®µå¹¶è‡ªåŠ¨å¡«å†™...`);
                setTimeout(() => {
                    addMessage('agent', 'âœ… è¯†åˆ«å®Œæˆ!å·²ä»è¾…åŠ©ææ–™ä¸­æå–å¹¶å¡«å†™äº†ä»¥ä¸‹å­—æ®µ:å§“åã€èº«ä»½è¯å·ã€æˆ¿å±‹ç»“æ„ã€‚æ‚¨å¯ä»¥ç»§ç»­æ‰‹åŠ¨è¡¥å……å…¶ä»–å­—æ®µã€‚', { type: 'fillResult' });
                }, 2000);
            }
        }

        function handleAudienceSelect(audience) {
            if (audience === 'household') {
                currentStep = 'sendConfirm';
                addMessage('agent', 'å·²ä¸ºæ‚¨é€‰ä¸­æ‰€æœ‰æˆ·ä¸»,å…±152äººã€‚è¯·ç¡®è®¤é€šçŸ¥å†…å®¹,ç‚¹å‡»å³å¯å‘é€ã€‚', { type: 'sendConfirm' });
            } else if (audience === 'specific') {
                addMessage('agent', 'è¯·é€‰æ‹©ç‰¹å®šäººç¾¤ç±»å‹:', { type: 'specificAudience' });
            } else if (audience === 'all') {
                currentStep = 'sendConfirm';
                addMessage('agent', 'å·²ä¸ºæ‚¨é€‰ä¸­å…¨ä½“æ‘æ°‘,å…±328äººã€‚è¯·ç¡®è®¤é€šçŸ¥å†…å®¹,ç‚¹å‡»å³å¯å‘é€ã€‚', { type: 'sendConfirm', count: 328 });
            } else if (audience === 'custom') {
                addMessage('agent', 'è¯·è‡ªå®šä¹‰é€‰æ‹©éœ€è¦é€šçŸ¥çš„äººå‘˜:', { type: 'customAudience' });
            }
        }

        function handleSpecificAudienceSelect(type) {
            const audienceMap = {
                'lowIncome': { name: 'ä½ä¿æˆ·', count: 45 },
                'elderly': { name: '60å²ä»¥ä¸Šè€äºº', count: 89 },
                'disabled': { name: 'æ®‹ç–¾äºº', count: 23 },
                'poverty': { name: 'å»ºæ¡£ç«‹å¡è´«å›°æˆ·', count: 37 }
            };
            const selected = audienceMap[type];
            currentStep = 'sendConfirm';
            addMessage('agent', `å·²ä¸ºæ‚¨é€‰ä¸­${selected.name},å…±${selected.count}äººã€‚è¯·ç¡®è®¤é€šçŸ¥å†…å®¹,ç‚¹å‡»å³å¯å‘é€ã€‚`, { type: 'sendConfirm', count: selected.count });
        }

        function handleCustomAudienceConfirm() {
            currentStep = 'sendConfirm';
            addMessage('agent', 'å·²ä¸ºæ‚¨é€‰ä¸­è‡ªå®šä¹‰äººå‘˜,å…±67äººã€‚è¯·ç¡®è®¤é€šçŸ¥å†…å®¹,ç‚¹å‡»å³å¯å‘é€ã€‚', { type: 'sendConfirm', count: 67 });
        }

        function handleSendConfirm(count = 152) {
            currentStep = 'sent';
            addMessage('agent', `âœ… å‘é€æˆåŠŸ!æ‘æ°‘ä»¬ä¼šæ”¶åˆ°å¡«è¡¨é€šçŸ¥çš„ã€‚æ‚¨å¯ä»¥éšæ—¶ç‚¹å‡»é¡¶éƒ¨çš„ [ğŸ“Š ä»»å‹™æƒ…æ³] æŒ‰é’®æ¥æŸ¥çœ‹å¡«å†™è¿›åº¦ã€‚`);
        }

        function handleViewDetailList() {
            addMessage('agent', 'è¿™æ˜¯æœªå¡«å†™äººå‘˜çš„è¯¦ç»†åå•,æ‚¨å¯ä»¥è¿›è¡Œå‚¬åŠæˆ–ä»£å¡«æ“ä½œã€‚', { type: 'detailList' });
        }

        function handleSelectPerson(id) {
            if (selectedPeople.includes(id)) {
                selectedPeople = selectedPeople.filter(pid => pid !== id);
                selectAll = false;
            } else {
                selectedPeople.push(id);
                if (selectedPeople.length === peopleList.length) {
                    selectAll = true;
                }
            }
            // é‡æ–°æ¸²æŸ“å½“å‰å¡ç‰‡
            const lastMessage = document.querySelector('.message:last-child .card');
            if (lastMessage) {
                lastMessage.outerHTML = renderDetailListCard();
            }
        }

        function handleSelectAll() {
            if (selectAll) {
                selectedPeople = [];
                selectAll = false;
            } else {
                selectedPeople = peopleList.map(p => p.id);
                selectAll = true;
            }
            // é‡æ–°æ¸²æŸ“å½“å‰å¡ç‰‡
            const lastMessage = document.querySelector('.message:last-child .card');
            if (lastMessage) {
                lastMessage.outerHTML = renderDetailListCard();
            }
        }

        function handleFillFor(name) {
            addMessage('agent', `å¥½çš„,è¯·å¼€å§‹ä¸º'${name}'å¡«å†™ä¿¡æ¯ã€‚`, { type: 'fillForm', name: name });
        }

        function handleBatchRemind() {
            if (selectedPeople.length > 0) {
                addMessage('agent', `âœ… æ“ä½œæˆåŠŸ!æé†’æ¶ˆæ¯å·²å‘é€ç»™é€‰ä¸­çš„${selectedPeople.length}ä½æ‘æ°‘ã€‚`);
            }
        }

        function handleRemindAll() {
            addMessage('agent', 'å¥½çš„,æé†’æ¶ˆæ¯å·²æˆåŠŸå‘é€ç»™å…¨éƒ¨117ä½æœªå¡«å†™çš„æ‘æ°‘ã€‚');
        }

        function handleExportDraft() {
            addMessage('agent', 'âœ… è‰ç¨¿å·²å¯¼å‡ºã€‚è¯·æ‚¨å¤„ç†å®Œæ¯•å,å°†æœ€ç»ˆç‰ˆæ–‡ä»¶ç›´æ¥æ‹–æ‹½åˆ°è¿™é‡Œ,æˆ–åœ¨ä¸‹æ–¹å¯¹è¯æ¡†è¾“å…¥"ä¸Šä¼ æœ€ç»ˆç‰ˆ",æˆ‘å°†ä¸ºæ‚¨å®Œæˆåç»­çš„æ•°æ®æ›´æ–°ã€‚');
        }

        function handleSendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (message) {
                addMessage('user', message);
                if (message.includes('ä¸Šä¼ æœ€ç»ˆç‰ˆ')) {
                    setTimeout(() => {
                        addMessage('agent', 'å¥½çš„,è¯·ä¸Šä¼ æ‚¨çš„æœ€ç»ˆç‰ˆExcelæ–‡ä»¶,æˆ‘å°†ä¸ºæ‚¨è¿›è¡Œæ•°æ®æ¯”å¯¹ä¸æ›´æ–°åˆ°"æ‘å¤§è¡¨"ã€‚', { type: 'fileUpload' });
                    }, 500);
                }
                input.value = '';
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                handleSendMessage();
            }
        }
    </script>
</body>
</html>